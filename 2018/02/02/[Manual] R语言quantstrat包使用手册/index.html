<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          [Manual] R语言quantstrat包使用手册 - 南有嘉鱼 | 南有樛木
        
    </title>

    <link rel="canonical" href="https://liangzhenghua.github.io/2018/02/02/[Manual] R语言quantstrat包使用手册/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/img/python.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#R" title="R">R</a>
                            
                              <a class="tag" href="/tags/#quant" title="quant">quant</a>
                            
                        </div>
                        <h1>[Manual] R语言quantstrat包使用手册</h1>
                        <h2 class="subheading">绕题太远了</h2>
                        <span class="meta">
                            Posted by Leung ZhengHua on
                            2018-02-02
                        </span>
						<!-- 测试阅读量 -->
						<br></br>
                        <span class="meta" id="busuanzi_container_page_pv">本文总点击量<span id="busuanzi_value_page_pv"></span>次
                        <!-- 测试阅读量 -->
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">三刃木正久化十</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/Gallery/">Gallery</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                </ul>
            </div>



        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->

<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>在阅读本文之前，你可能对以下扫盲贴有兴趣：</p>
<p><a href="https://timtrice.github.io/backtesting-strategies/index.html" target="_blank" rel="external">强烈推荐《Backtesting Strategies with R》</a><br><a href="https://zhuanlan.zhihu.com/p/20232919?refer=scientific-invest" target="_blank" rel="external">如何搭建量化投资研究系统之三（工具篇quantstrat）</a><br><a href="https://www.quantinsti.com/blog/quantitative-trading-strategy-using-r/" target="_blank" rel="external">Quantitative Trading Strategy Using Quantstrat Package in R: A Step by Step Guide</a><br><a href="http://download.r-forge.r-project.org/bin/windows/contrib/" target="_blank" rel="external">R Forge package 地址</a><br><a href="https://www.r-bloggers.com/a-hammer-trading-system-demonstrating-custom-indicator-based-limit-orders-in-quantstrat/" target="_blank" rel="external">A Hammer Trading System — Demonstrating Custom Indicator-Based Limit Orders in Quantstrat</a><br><a href="https://github.com/R-Finance/quantstrat/blob/master/sandbox/QuantstratWorkshop.pdf" target="_blank" rel="external">一份你可能不太想阅读的QuantstratWorkshop.pdf</a></p>
<hr>
<p>先来一段代码压压惊吧：</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div><div class="line">459</div><div class="line">460</div><div class="line">461</div><div class="line">462</div><div class="line">463</div><div class="line">464</div><div class="line">465</div><div class="line">466</div><div class="line">467</div><div class="line">468</div><div class="line">469</div><div class="line">470</div><div class="line">471</div><div class="line">472</div><div class="line">473</div><div class="line">474</div><div class="line">475</div><div class="line">476</div><div class="line">477</div><div class="line">478</div><div class="line">479</div><div class="line">480</div><div class="line">481</div><div class="line">482</div><div class="line">483</div><div class="line">484</div><div class="line">485</div><div class="line">486</div><div class="line">487</div><div class="line">488</div><div class="line">489</div><div class="line">490</div><div class="line">491</div><div class="line">492</div><div class="line">493</div><div class="line">494</div><div class="line">495</div><div class="line">496</div><div class="line">497</div><div class="line">498</div><div class="line">499</div><div class="line">500</div><div class="line">501</div><div class="line">502</div><div class="line">503</div><div class="line">504</div><div class="line">505</div><div class="line">506</div><div class="line">507</div><div class="line">508</div><div class="line">509</div><div class="line">510</div><div class="line">511</div><div class="line">512</div><div class="line">513</div><div class="line">514</div><div class="line">515</div><div class="line">516</div><div class="line">517</div><div class="line">518</div><div class="line">519</div><div class="line">520</div><div class="line">521</div><div class="line">522</div><div class="line">523</div><div class="line">524</div><div class="line">525</div><div class="line">526</div><div class="line">527</div><div class="line">528</div><div class="line">529</div><div class="line">530</div><div class="line">531</div><div class="line">532</div><div class="line">533</div><div class="line">534</div><div class="line">535</div><div class="line">536</div><div class="line">537</div><div class="line">538</div><div class="line">539</div><div class="line">540</div><div class="line">541</div><div class="line">542</div><div class="line">543</div><div class="line">544</div><div class="line">545</div><div class="line">546</div><div class="line">547</div><div class="line">548</div><div class="line">549</div><div class="line">550</div><div class="line">551</div><div class="line">552</div><div class="line">553</div><div class="line">554</div><div class="line">555</div><div class="line">556</div><div class="line">557</div><div class="line">558</div><div class="line">559</div><div class="line">560</div><div class="line">561</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># _________________________________</span></div><div class="line"></div><div class="line"><span class="comment"># date: 2017-02-02</span></div><div class="line"></div><div class="line"><span class="comment"># version: 0.1</span></div><div class="line"></div><div class="line"><span class="comment"># backtesting-strategies learning</span></div><div class="line"></div><div class="line"><span class="comment"># 我们约定，注释中一个#表示一级标题；两个#表示二级标题</span></div><div class="line"><span class="comment"># 正文注释使用 # *** ￥%#……￥*@！***</span></div><div class="line"><span class="comment"># 你需要某些技术手段去翻墙，比如XXnet，好吧，其实没有人看这篇东西</span></div><div class="line"><span class="comment"># 因为要从google得到案例数据，yahoo已废</span></div><div class="line"><span class="comment"># 这个脚本完完全全是抄袭了《backtesting-strategies》中的前5章和第12章</span></div><div class="line"><span class="comment"># 你看，把这个脚本从头跑一遍就可以读掉了半本书</span></div><div class="line"><span class="comment"># 作者越往后写的文字越少，其实把代码全扒下来，剩下的东西也没什么营养了</span></div><div class="line"><span class="comment"># 我还会回来的</span></div><div class="line"> </div><div class="line"><span class="comment"># ________________________________</span></div><div class="line"></div><div class="line"><span class="comment"># Chapter 1 Libraries</span></div><div class="line"></div><div class="line"><span class="comment"># *** 下面是你需要安装的包 ***</span></div><div class="line"></div><div class="line"><span class="keyword">library</span>(quantstrat)</div><div class="line"><span class="keyword">library</span>(data.table)</div><div class="line"><span class="keyword">library</span>(dplyr)</div><div class="line"><span class="keyword">library</span>(DT)</div><div class="line"><span class="keyword">library</span>(ggplot2)</div><div class="line"><span class="keyword">library</span>(htmltools)</div><div class="line"><span class="keyword">library</span>(htmlwidgets)</div><div class="line"><span class="keyword">library</span>(knitr)</div><div class="line"><span class="keyword">library</span>(lattice)</div><div class="line"><span class="keyword">library</span>(pander)</div><div class="line"><span class="keyword">library</span>(tidyr)</div><div class="line"><span class="keyword">library</span>(webshot)</div><div class="line"></div><div class="line"><span class="comment"># Chapter 2 Terminology</span></div><div class="line"></div><div class="line"><span class="comment"># *** BTO: Buy to Open (open long positions) ***</span></div><div class="line"></div><div class="line"><span class="comment"># *** BTC: Buy to close (close short positions) ***</span></div><div class="line"></div><div class="line"><span class="comment"># *** SL: Stop-limit order ***</span></div><div class="line"></div><div class="line"><span class="comment"># *** STO: Sell to open (open short positions) ***</span></div><div class="line"></div><div class="line"><span class="comment"># *** STC: Sell to close (close long positions) ***</span></div><div class="line"></div><div class="line"><span class="comment"># *** TS: Trailing-stop order ***</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## 3.1 Settings and Variables</span></div><div class="line"></div><div class="line"><span class="comment"># *** 设定美帝的时区和货币种类 ***</span></div><div class="line">Sys.setenv(TZ = <span class="string">"UTC"</span>)</div><div class="line">currency(<span class="string">'USD'</span>)</div><div class="line"></div><div class="line"><span class="comment"># *** 初始化起止日和账户资金 ***</span></div><div class="line">init_date &lt;- <span class="string">"2007-12-31"</span></div><div class="line">start_date &lt;- <span class="string">"2008-01-01"</span></div><div class="line">end_date &lt;- <span class="string">"2009-12-31"</span></div><div class="line">init_equity &lt;- <span class="number">1e4</span> <span class="comment"># $10,000</span></div><div class="line">adjustment &lt;- <span class="literal">TRUE</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## 3.2 Symbols</span></div><div class="line"></div><div class="line"><span class="comment"># *** 设定测试中所用的股票代码 ***</span></div><div class="line">basic_symbols &lt;- <span class="keyword">function</span>() &#123;</div><div class="line">  symbols &lt;- c(</div><div class="line">    <span class="string">"IWM"</span>, <span class="comment"># iShares Russell 2000 Index ETF</span></div><div class="line">    <span class="string">"QQQ"</span>, <span class="comment"># PowerShares QQQ TRust, Series 1 ETF</span></div><div class="line">    <span class="string">"SPY"</span> <span class="comment"># SPDR S&amp;P 500 ETF Trust</span></div><div class="line">  )</div><div class="line">&#125;</div><div class="line"></div><div class="line">enhanced_symbols &lt;- <span class="keyword">function</span>() &#123;</div><div class="line">  symbols &lt;- c(</div><div class="line">    basic_symbols(), </div><div class="line">    <span class="string">"TLT"</span>, <span class="comment"># iShares Barclays 20+ Yr Treas. Bond ETF</span></div><div class="line">    <span class="string">"XLB"</span>, <span class="comment"># Materials Select Sector SPDR ETF</span></div><div class="line">    <span class="string">"XLE"</span>, <span class="comment"># Energy Select Sector SPDR ETF</span></div><div class="line">    <span class="string">"XLF"</span>, <span class="comment"># Financial Select Sector SPDR ETF</span></div><div class="line">    <span class="string">"XLI"</span>, <span class="comment"># Industrials Select Sector SPDR ETF</span></div><div class="line">    <span class="string">"XLK"</span>, <span class="comment"># Technology  Select Sector SPDR ETF</span></div><div class="line">    <span class="string">"XLP"</span>, <span class="comment"># Consumer Staples  Select Sector SPDR ETF</span></div><div class="line">    <span class="string">"XLU"</span>, <span class="comment"># Utilities  Select Sector SPDR ETF</span></div><div class="line">    <span class="string">"XLV"</span>, <span class="comment"># Health Care  Select Sector SPDR ETF</span></div><div class="line">    <span class="string">"XLY"</span> <span class="comment"># Consumer Discretionary  Select Sector SPDR ETF</span></div><div class="line">  )</div><div class="line">&#125;</div><div class="line"></div><div class="line">global_symbols &lt;- <span class="keyword">function</span>() &#123;</div><div class="line">  symbols &lt;- c(</div><div class="line">    enhanced_symbols(), </div><div class="line">    <span class="string">"EFA"</span>, <span class="comment"># iShares EAFE</span></div><div class="line">    <span class="string">"EPP"</span>, <span class="comment"># iShares Pacific Ex Japan</span></div><div class="line">    <span class="string">"EWA"</span>, <span class="comment"># iShares Australia</span></div><div class="line">    <span class="string">"EWC"</span>, <span class="comment"># iShares Canada</span></div><div class="line">    <span class="string">"EWG"</span>, <span class="comment"># iShares Germany</span></div><div class="line">    <span class="string">"EWH"</span>, <span class="comment"># iShares Hong Kong</span></div><div class="line">    <span class="string">"EWJ"</span>, <span class="comment"># iShares Japan</span></div><div class="line">    <span class="string">"EWS"</span>, <span class="comment"># iShares Singapore</span></div><div class="line">    <span class="string">"EWT"</span>, <span class="comment"># iShares Taiwan</span></div><div class="line">    <span class="string">"EWU"</span>, <span class="comment"># iShares UK</span></div><div class="line">    <span class="string">"EWY"</span>, <span class="comment"># iShares South Korea</span></div><div class="line">    <span class="string">"EWZ"</span>, <span class="comment"># iShares Brazil</span></div><div class="line">    <span class="string">"EZU"</span>, <span class="comment"># iShares MSCI EMU ETF</span></div><div class="line">    <span class="string">"IGE"</span>, <span class="comment"># iShares North American Natural Resources</span></div><div class="line">    <span class="string">"IYR"</span>, <span class="comment"># iShares U.S. Real Estate</span></div><div class="line">    <span class="string">"IYZ"</span>, <span class="comment"># iShares U.S. Telecom</span></div><div class="line">    <span class="string">"LQD"</span>, <span class="comment"># iShares Investment Grade Corporate Bonds</span></div><div class="line">    <span class="string">"SHY"</span> <span class="comment"># iShares 42372 year TBonds</span></div><div class="line">  )</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## 3.3 checkBlotterUpdate()</span></div><div class="line"></div><div class="line"><span class="comment"># Guy Yollin, 2014</span></div><div class="line"><span class="comment"># http://www.r-programming.org/papers</span></div><div class="line"></div><div class="line">checkBlotterUpdate &lt;- <span class="keyword">function</span>(port.st = portfolio.st, </div><div class="line">                               account.st = account.st, </div><div class="line">                               verbose = <span class="literal">TRUE</span>) &#123;</div><div class="line">  </div><div class="line">  ok &lt;- <span class="literal">TRUE</span></div><div class="line">  p &lt;- getPortfolio(port.st)</div><div class="line">  a &lt;- getAccount(account.st)</div><div class="line">  syms &lt;- names(p$symbols)</div><div class="line">  port.tot &lt;- sum(</div><div class="line">    sapply(</div><div class="line">      syms, </div><div class="line">      FUN = <span class="keyword">function</span>(x) eval(</div><div class="line">        parse(</div><div class="line">          text = paste(<span class="string">"sum(p$symbols"</span>, </div><div class="line">                       x, </div><div class="line">                       <span class="string">"posPL.USD$Net.Trading.PL)"</span>, </div><div class="line">                       sep = <span class="string">"$"</span>)))))</div><div class="line">  </div><div class="line">  port.sum.tot &lt;- sum(p$summary$Net.Trading.PL)</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(!isTRUE(all.equal(port.tot, port.sum.tot))) &#123;</div><div class="line">    ok &lt;- <span class="literal">FALSE</span></div><div class="line">    <span class="keyword">if</span>(verbose) print(<span class="string">"portfolio P&amp;L doesn't match sum of symbols P&amp;L"</span>)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  initEq &lt;- as.numeric(first(a$summary$End.Eq))</div><div class="line">  endEq &lt;- as.numeric(last(a$summary$End.Eq))</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(!isTRUE(all.equal(port.tot, endEq - initEq)) ) &#123;</div><div class="line">    ok &lt;- <span class="literal">FALSE</span></div><div class="line">    <span class="keyword">if</span>(verbose) print(<span class="string">"portfolio P&amp;L doesn't match account P&amp;L"</span>)</div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(sum(duplicated(index(p$summary)))) &#123;</div><div class="line">    ok &lt;- <span class="literal">FALSE</span></div><div class="line">    <span class="keyword">if</span>(verbose)print(<span class="string">"duplicate timestamps in portfolio summary"</span>)</div><div class="line">    </div><div class="line">  &#125;</div><div class="line">  </div><div class="line">  <span class="keyword">if</span>(sum(duplicated(index(a$summary)))) &#123;</div><div class="line">    ok &lt;- <span class="literal">FALSE</span></div><div class="line">    <span class="keyword">if</span>(verbose) print(<span class="string">"duplicate timestamps in account summary"</span>)</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span>(ok)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment"># *** checkBlotterUpdate是用于检查账户和资产组合，如果返回FALSE，需要检查还有哪些账户和资产组合还在R的工作空间里 ***</span></div><div class="line"></div><div class="line"><span class="comment"># 4 Get Symbols</span></div><div class="line"></div><div class="line">print(basic_symbols())</div><div class="line">symbols &lt;- basic_symbols()</div><div class="line"></div><div class="line"><span class="comment"># *** 我需要翻墙google才能使用getSymbols这个函数 ***</span></div><div class="line"><span class="comment"># *** getSymbols函数的作用是返回各个symbol（股票）的数据，每个symbol是一个数据框 ***</span></div><div class="line">getSymbols(Symbols = symbols, </div><div class="line">           src = <span class="string">"google"</span>, </div><div class="line">           index.class = <span class="string">"POSIXct"</span>,</div><div class="line">           from = start_date, </div><div class="line">           to = end_date, </div><div class="line">           adjust = adjustment)</div><div class="line"></div><div class="line"><span class="comment"># *** 观察拉取的数据 ***</span></div><div class="line">head(IWM) </div><div class="line">tail(IWM)</div><div class="line"></div><div class="line">chartSeries(SPY)</div><div class="line"></div><div class="line"><span class="comment"># 5 Basic Strategy</span></div><div class="line"></div><div class="line"><span class="comment">## 5.1 Strategy Setup</span></div><div class="line"></div><div class="line"><span class="comment"># *** 将需要交易的symbol用stock绑定到某工作空间 ***</span></div><div class="line">stock(symbols, </div><div class="line">      currency = <span class="string">"USD"</span>, </div><div class="line">      multiplier = <span class="number">1</span>)</div><div class="line"></div><div class="line"><span class="comment"># *** 命名你的资产组合、账户名称和策略名称，以免你贵人多忘事 ***</span></div><div class="line">portfolio.st &lt;- <span class="string">"Port.Luxor"</span></div><div class="line">account.st &lt;- <span class="string">"Acct.Luxor"</span></div><div class="line">strategy.st &lt;- <span class="string">"Strat.Luxor"</span></div><div class="line"></div><div class="line"><span class="comment"># *** 保守起见，将历史上可能遗留在工作空间的资产组合和账户全部销毁 ***</span></div><div class="line">rm.strat(portfolio.st)</div><div class="line">rm.strat(account.st)</div><div class="line"></div><div class="line"><span class="comment"># *** 初始化资产组合和账户 ***</span></div><div class="line">initPortf(name = portfolio.st,</div><div class="line">          symbols = symbols,</div><div class="line">          initDate = init_date)</div><div class="line"></div><div class="line">initAcct(name = account.st,</div><div class="line">         portfolios = portfolio.st,</div><div class="line">         initDate = init_date,</div><div class="line">         initEq = init_equity)</div><div class="line"></div><div class="line">initOrders(portfolio = portfolio.st,</div><div class="line">           symbols = symbols,</div><div class="line">           initDate = init_date)</div><div class="line"></div><div class="line">strategy(strategy.st, store = <span class="literal">TRUE</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## 5.2 Add Indicators</span></div><div class="line"></div><div class="line"><span class="comment"># *** 我们以双均线策略为例继续我们的练习 ***</span></div><div class="line"><span class="comment"># *** 短期均线SMA(10)上穿长期均线SMA(30)表明短期内会上涨，应买入 ***</span></div><div class="line"><span class="comment"># *** 短期均线SMA(10)下穿长期均线SMA(30)表明短期内会下跌，应卖出 ***</span></div><div class="line"></div><div class="line"><span class="comment"># *** add.indicator是一个给我们策略添加指标的函数 ***</span></div><div class="line"><span class="comment"># *** 具体地理解就是给每个股票的数据框增加一列指标 *** </span></div><div class="line"><span class="comment"># *** 比如SMA10,是最近10期价格的平均 ***</span></div><div class="line"><span class="comment"># *** name的输入应当是一个函数的名称，arguments是这个函数的输入参数 ***</span></div><div class="line"><span class="comment"># *** SMA这个函数来自TTR包 ***</span></div><div class="line"><span class="comment"># *** label标明了在数据集里增加的新的一列指标的名字 ***</span></div><div class="line"><span class="comment"># *** 可以看到最重要最复杂的是arguments ***</span></div><div class="line"><span class="comment"># *** 如果你想引用数据集中某一列，赋值给x,请参考 x=IWM$Close ***</span></div><div class="line"><span class="comment"># *** mktdata 是一个特殊的数据集，存储了我们的signal和indicator *** </span></div><div class="line"><span class="comment"># *** 当apply你的策略时，你可以看到最后一个symbol的mktdata ***</span></div><div class="line"><span class="comment"># *** Cl 是close的缩写，暂时可以忽略它***</span></div><div class="line"></div><div class="line">add.indicator(strategy = strategy.st,</div><div class="line">              name = <span class="string">"SMA"</span>,</div><div class="line">              arguments = list(x = quote(Cl(mktdata)), </div><div class="line">                               n = <span class="number">10</span>),</div><div class="line">              label = <span class="string">"nFast"</span>)</div><div class="line"></div><div class="line">add.indicator(strategy = strategy.st, </div><div class="line">              name = <span class="string">"SMA"</span>, </div><div class="line">              arguments = list(x = quote(Cl(mktdata)), </div><div class="line">                               n = <span class="number">30</span>), </div><div class="line">              label = <span class="string">"nSlow"</span>)</div><div class="line"></div><div class="line"><span class="comment">## 5.3 Add Signals</span></div><div class="line"></div><div class="line"><span class="comment"># *** 同上的解释 ***</span></div><div class="line"></div><div class="line">add.signal(strategy = strategy.st,</div><div class="line">           name=<span class="string">"sigCrossover"</span>,</div><div class="line">           arguments = list(columns = c(<span class="string">"nFast"</span>, <span class="string">"nSlow"</span>),</div><div class="line">                            relationship = <span class="string">"gte"</span>),</div><div class="line">           label = <span class="string">"long"</span>)</div><div class="line"></div><div class="line">add.signal(strategy = strategy.st,</div><div class="line">           name=<span class="string">"sigCrossover"</span>,</div><div class="line">           arguments = list(columns = c(<span class="string">"nFast"</span>, <span class="string">"nSlow"</span>),</div><div class="line">                            relationship = <span class="string">"lt"</span>),</div><div class="line">           label = <span class="string">"short"</span>)</div><div class="line"></div><div class="line"><span class="comment">## 5.4 Add Rules</span></div><div class="line"></div><div class="line"><span class="comment"># *** 同上的解释 ***</span></div><div class="line"></div><div class="line">add.rule(strategy = strategy.st,</div><div class="line">         name = <span class="string">"ruleSignal"</span>,</div><div class="line">         arguments = list(sigcol = <span class="string">"long"</span>,</div><div class="line">                          sigval = <span class="literal">TRUE</span>,</div><div class="line">                          orderqty = <span class="number">100</span>,</div><div class="line">                          ordertype = <span class="string">"stoplimit"</span>,</div><div class="line">                          orderside = <span class="string">"long"</span>, </div><div class="line">                          threshold = <span class="number">0.0005</span>,</div><div class="line">                          prefer = <span class="string">"High"</span>, </div><div class="line">                          TxnFees = -<span class="number">10</span>, </div><div class="line">                          replace = <span class="literal">FALSE</span>),</div><div class="line">         type = <span class="string">"enter"</span>,</div><div class="line">         label = <span class="string">"EnterLONG"</span>)</div><div class="line"></div><div class="line"></div><div class="line">add.rule(strategy.st,</div><div class="line">         name = <span class="string">"ruleSignal"</span>,</div><div class="line">         arguments = list(sigcol = <span class="string">"short"</span>,</div><div class="line">                          sigval = <span class="literal">TRUE</span>,</div><div class="line">                          orderqty = -<span class="number">100</span>,</div><div class="line">                          ordertype = <span class="string">"stoplimit"</span>,</div><div class="line">                          threshold = -<span class="number">0.005</span>, </div><div class="line">                          orderside = <span class="string">"short"</span>, </div><div class="line">                          replace = <span class="literal">FALSE</span>, </div><div class="line">                          TxnFees = -<span class="number">10</span>, </div><div class="line">                          prefer = <span class="string">"Low"</span>),</div><div class="line">         type = <span class="string">"enter"</span>,</div><div class="line">         label = <span class="string">"EnterSHORT"</span>)</div><div class="line"></div><div class="line">add.rule(strategy.st, </div><div class="line">         name = <span class="string">"ruleSignal"</span>, </div><div class="line">         arguments = list(sigcol = <span class="string">"short"</span>, </div><div class="line">                          sigval = <span class="literal">TRUE</span>, </div><div class="line">                          orderside = <span class="string">"long"</span>, </div><div class="line">                          ordertype = <span class="string">"market"</span>, </div><div class="line">                          orderqty = <span class="string">"all"</span>, </div><div class="line">                          TxnFees = -<span class="number">10</span>, </div><div class="line">                          replace = <span class="literal">TRUE</span>), </div><div class="line">         type = <span class="string">"exit"</span>, </div><div class="line">         label = <span class="string">"Exit2SHORT"</span>)</div><div class="line"></div><div class="line">add.rule(strategy.st, </div><div class="line">         name = <span class="string">"ruleSignal"</span>, </div><div class="line">         arguments = list(sigcol = <span class="string">"long"</span>, </div><div class="line">                          sigval = <span class="literal">TRUE</span>, </div><div class="line">                          orderside = <span class="string">"short"</span>, </div><div class="line">                          ordertype = <span class="string">"market"</span>, </div><div class="line">                          orderqty = <span class="string">"all"</span>, </div><div class="line">                          TxnFees = -<span class="number">10</span>, </div><div class="line">                          replace = <span class="literal">TRUE</span>), </div><div class="line">         type = <span class="string">"exit"</span>, </div><div class="line">         label = <span class="string">"Exit2LONG"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 5.5 Apply Strategy</span></div><div class="line"></div><div class="line"><span class="comment"># *** 执行你的策略，得到回测结果 ***</span></div><div class="line"></div><div class="line">cwd &lt;- getwd()</div><div class="line">setwd(<span class="string">"./_data/"</span>)</div><div class="line">results_file &lt;- paste(<span class="string">"results"</span>, strategy.st, <span class="string">"RData"</span>, sep = <span class="string">"."</span>)</div><div class="line"><span class="keyword">if</span>( file.exists(results_file) ) &#123;</div><div class="line">  load(results_file)</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">  results &lt;- applyStrategy(strategy.st, portfolios = portfolio.st)</div><div class="line">  updatePortf(portfolio.st)</div><div class="line">  updateAcct(account.st)</div><div class="line">  updateEndEq(account.st)</div><div class="line">  <span class="keyword">if</span>(checkBlotterUpdate(portfolio.st, account.st, verbose = <span class="literal">TRUE</span>)) &#123;</div><div class="line">    save(list = <span class="string">"results"</span>, file = results_file)</div><div class="line">    save.strategy(strategy.st)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">setwd(cwd)</div><div class="line"></div><div class="line"><span class="comment"># Chapter 12 Analyzing Results</span></div><div class="line"></div><div class="line"><span class="comment">## 12.1 Apply Strategy</span></div><div class="line"></div><div class="line"><span class="comment"># *** 这一小节实际上和前面重复了，可以不执行 ***</span></div><div class="line"></div><div class="line">checkBlotterUpdate(portfolio.st, account.st, verbose = <span class="literal">TRUE</span>)</div><div class="line"></div><div class="line">updatePortf(portfolio.st)</div><div class="line"></div><div class="line">updateAcct(account.st)</div><div class="line"></div><div class="line">updateEndEq(account.st)</div><div class="line"></div><div class="line"><span class="comment">## 12.2 Chart Positions</span></div><div class="line"></div><div class="line"><span class="comment"># *** 画出仓位走势图 ***</span></div><div class="line"></div><div class="line"><span class="keyword">for</span>(symbol <span class="keyword">in</span> symbols) &#123;</div><div class="line">  chart.Posn(portfolio.st, Symbol = symbol, </div><div class="line">             TA = <span class="string">"add_SMA(n = 10, col = 4); add_SMA(n = 30, col = 2)"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">## 12.3 Trade Statistics</span></div><div class="line"></div><div class="line">tstats &lt;- tradeStats(portfolio.st)</div><div class="line">kable(t(tstats))</div><div class="line"></div><div class="line"><span class="comment">### 12.3.1 Trade Related</span></div><div class="line"></div><div class="line">tab.trades &lt;- tstats %&gt;% </div><div class="line">  mutate(Trades = Num.Trades, </div><div class="line">         Win.Percent = Percent.Positive, </div><div class="line">         Loss.Percent = Percent.Negative, </div><div class="line">         WL.Ratio = Percent.Positive/Percent.Negative) %&gt;% </div><div class="line">  select(Trades, Win.Percent, Loss.Percent, WL.Ratio)</div><div class="line"><span class="comment"># 我自己加上去的，不然下一句报错the table must have a header (column names)</span></div><div class="line">rownames(tab.trades)=c(<span class="string">'stock1'</span>,<span class="string">'stock2'</span>,<span class="string">'stock3'</span>) </div><div class="line">kable(t(tab.trades))</div><div class="line"></div><div class="line"><span class="comment">### 12.3.2 Profit Related</span></div><div class="line"></div><div class="line">tab.profit &lt;- tstats %&gt;% </div><div class="line">  select(Net.Trading.PL, Gross.Profits, Gross.Losses, Profit.Factor)</div><div class="line">kable(t(tab.profit))</div><div class="line"></div><div class="line"><span class="comment">### 12.3.3 Averages</span></div><div class="line"></div><div class="line">tab.wins &lt;- tstats %&gt;% </div><div class="line">  select(Avg.Trade.PL, Avg.Win.Trade, Avg.Losing.Trade, Avg.WinLoss.Ratio)</div><div class="line"></div><div class="line">kable(t(tab.wins))</div><div class="line"></div><div class="line"><span class="comment">### 12.3.4 Performance Summary</span></div><div class="line"></div><div class="line">rets &lt;- PortfReturns(Account = account.st)</div><div class="line">rownames(rets) &lt;- <span class="literal">NULL</span></div><div class="line">charts.PerformanceSummary(rets, colorset = bluefocus)</div><div class="line"></div><div class="line"><span class="comment">### 12.3.5 Per Trade Statistics</span></div><div class="line"></div><div class="line"><span class="keyword">for</span>(symbol <span class="keyword">in</span> symbols) &#123;</div><div class="line">  pts &lt;- perTradeStats(portfolio.st, Symbol = symbol)</div><div class="line">  kable(pts, booktabs = <span class="literal">TRUE</span>, caption = symbol)</div><div class="line">&#125;</div><div class="line">kable(pts)</div><div class="line"></div><div class="line"><span class="comment">### 12.3.6 Performance Statistics</span></div><div class="line"></div><div class="line">tab.perf &lt;- table.Arbitrary(rets,</div><div class="line">                            metrics=c(</div><div class="line">                              <span class="string">"Return.cumulative"</span>,</div><div class="line">                              <span class="string">"Return.annualized"</span>,</div><div class="line">                              <span class="string">"SharpeRatio.annualized"</span>,</div><div class="line">                              <span class="string">"CalmarRatio"</span>),</div><div class="line">                            metricsNames=c(</div><div class="line">                              <span class="string">"Cumulative Return"</span>,</div><div class="line">                              <span class="string">"Annualized Return"</span>,</div><div class="line">                              <span class="string">"Annualized Sharpe Ratio"</span>,</div><div class="line">                              <span class="string">"Calmar Ratio"</span>))</div><div class="line">kable(tab.perf)</div><div class="line"></div><div class="line"><span class="comment">### 12.3.7 Risk Statistics</span></div><div class="line"></div><div class="line">tab.risk &lt;- table.Arbitrary(rets,</div><div class="line">                            metrics=c(</div><div class="line">                              <span class="string">"StdDev.annualized"</span>,</div><div class="line">                              <span class="string">"maxDrawdown"</span>,</div><div class="line">                              <span class="string">"VaR"</span>,</div><div class="line">                              <span class="string">"ES"</span>),</div><div class="line">                            metricsNames=c(</div><div class="line">                              <span class="string">"Annualized StdDev"</span>,</div><div class="line">                              <span class="string">"Max DrawDown"</span>,</div><div class="line">                              <span class="string">"Value-at-Risk"</span>,</div><div class="line">                              <span class="string">"Conditional VaR"</span>))</div><div class="line">kable(tab.risk)</div><div class="line"></div><div class="line"><span class="comment">### 12.3.8 Buy and Hold Performance</span></div><div class="line"></div><div class="line">rm.strat(<span class="string">"buyHold"</span>)</div><div class="line"></div><div class="line"><span class="comment"># initialize portfolio and account</span></div><div class="line">initPortf(<span class="string">"buyHold"</span>, <span class="string">"SPY"</span>, initDate = init_date)</div><div class="line">initAcct(<span class="string">"buyHold"</span>, portfolios = <span class="string">"buyHold"</span>,</div><div class="line">         initDate = init_date, initEq = init_equity)</div><div class="line"></div><div class="line"><span class="comment"># place an entry order</span></div><div class="line">CurrentDate &lt;- time(getTxns(Portfolio = portfolio.st, Symbol = <span class="string">"SPY"</span>))[<span class="number">2</span>]</div><div class="line">equity = getEndEq(<span class="string">"buyHold"</span>, CurrentDate)</div><div class="line">ClosePrice &lt;- as.numeric(Cl(SPY[CurrentDate,]))</div><div class="line">UnitSize = as.numeric(trunc(equity/ClosePrice))</div><div class="line">addTxn(<span class="string">"buyHold"</span>, Symbol = <span class="string">"SPY"</span>, TxnDate = CurrentDate, TxnPrice = ClosePrice,</div><div class="line">       TxnQty = UnitSize, TxnFees = <span class="number">0</span>)</div><div class="line"></div><div class="line"><span class="comment"># place an exit order</span></div><div class="line">LastDate &lt;- last(time(SPY))</div><div class="line">LastPrice &lt;- as.numeric(Cl(SPY[LastDate,]))</div><div class="line">addTxn(<span class="string">"buyHold"</span>, Symbol = <span class="string">"SPY"</span>, TxnDate = LastDate, TxnPrice = LastPrice,</div><div class="line">       TxnQty = -UnitSize , TxnFees = <span class="number">0</span>)</div><div class="line"></div><div class="line">updatePortf(Portfolio = <span class="string">"buyHold"</span>)</div><div class="line">updateAcct(name = <span class="string">"buyHold"</span>)</div><div class="line">updateEndEq(Account = <span class="string">"buyHold"</span>)</div><div class="line">chart.Posn(<span class="string">"buyHold"</span>, Symbol = <span class="string">"SPY"</span>)</div><div class="line"></div><div class="line"><span class="comment">### 12.3.9 Strategy vs. Market</span></div><div class="line"></div><div class="line">rets &lt;- PortfReturns(Account = account.st)</div><div class="line">rets.bh &lt;- PortfReturns(Account = <span class="string">"buyHold"</span>)</div><div class="line">returns &lt;- cbind(rets, rets.bh)</div><div class="line">charts.PerformanceSummary(returns, geometric = <span class="literal">FALSE</span>, wealth.index = <span class="literal">TRUE</span>, </div><div class="line">                          main = <span class="string">"Strategy vs. Market"</span>)</div><div class="line"></div><div class="line"><span class="comment">### 12.3.10 Risk/Return Scatterplot</span></div><div class="line"></div><div class="line">chart.RiskReturnScatter(returns, Rf = <span class="number">0</span>, add.sharpe = c(<span class="number">1</span>, <span class="number">2</span>), </div><div class="line">                        main = <span class="string">"Return vs. Risk"</span>, colorset = c(<span class="string">"red"</span>, <span class="string">"blue"</span>))</div><div class="line"></div><div class="line"><span class="comment">### 12.3.11 Relative Performance</span></div><div class="line"></div><div class="line"><span class="keyword">for</span>(n <span class="keyword">in</span> <span class="number">1</span>:(ncol(returns) - <span class="number">1</span>)) &#123;</div><div class="line">  chart.RelativePerformance(returns[, n], returns[, ncol(returns)], </div><div class="line">                            colorset = c(<span class="string">"red"</span>, <span class="string">"blue"</span>), lwd = <span class="number">2</span>, </div><div class="line">                            legend.loc = <span class="string">"topleft"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">### 12.3.12 Portfolio Summary</span></div><div class="line"></div><div class="line"><span class="comment">#' Error</span></div><div class="line">pf &lt;- getPortfolio(portfolio.st)</div><div class="line">xyplot(pf$summary, type = <span class="string">"h"</span>, col = <span class="number">4</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 12.3.13 Order Book</span></div><div class="line"></div><div class="line">ob &lt;- getOrderBook(portfolio.st)</div><div class="line"></div><div class="line"><span class="comment">### 12.3.14 Maximum Adverse Excursion</span></div><div class="line"></div><div class="line"><span class="keyword">for</span>(symbol <span class="keyword">in</span> symbols) &#123;</div><div class="line">  chart.ME(Portfolio = portfolio.st, Symbol = symbol, type = <span class="string">"MAE"</span>, </div><div class="line">           scale = <span class="string">"percent"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">### 12.3.15 Maximum Favorable Excursion</span></div><div class="line"></div><div class="line"><span class="keyword">for</span>(symbol <span class="keyword">in</span> symbols) &#123;</div><div class="line">  chart.ME(Portfolio = portfolio.st, Symbol = symbol, type = <span class="string">"MFE"</span>, </div><div class="line">           scale = <span class="string">"percent"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">## 12.4 Account Summary</span></div><div class="line"></div><div class="line">a &lt;- getAccount(account.st)</div><div class="line">xyplot(a$summary, type = <span class="string">"h"</span>, col = <span class="number">4</span>)</div><div class="line"></div><div class="line"><span class="comment">### 12.4.1 Equity Curve</span></div><div class="line"></div><div class="line">equity &lt;- a$summary$End.Eq</div><div class="line">plot(equity, main = <span class="string">"Equity Curve"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 12.4.2 Account Performance Summary</span></div><div class="line"></div><div class="line">ret &lt;- Return.calculate(equity, method = <span class="string">"log"</span>)</div><div class="line">charts.PerformanceSummary(ret, colorset = bluefocus, </div><div class="line">                          main = <span class="string">"Strategy Performance"</span>)</div><div class="line"></div><div class="line"><span class="comment">### 12.4.3 Cumulative Returns</span></div><div class="line"></div><div class="line">rets &lt;- PortfReturns(Account = account.st)</div><div class="line">chart.CumReturns(rets, colorset = rich10equal, legend.loc = <span class="string">"topleft"</span>, </div><div class="line">                 main=<span class="string">"SPDR Cumulative Returns"</span>)</div><div class="line"></div><div class="line"><span class="comment">### 12.4.4 Distribution Analysis</span></div><div class="line"></div><div class="line">chart.Boxplot(rets, main = <span class="string">"SPDR Returns"</span>, colorset= rich10equal)</div><div class="line"></div><div class="line"><span class="comment">### 12.4.5 Annualized Returns</span></div><div class="line"></div><div class="line">(ar.tab &lt;- table.AnnualizedReturns(rets))</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 12.4.6 Performance Scatter Plot</span></div><div class="line"></div><div class="line">max.risk &lt;- max(ar.tab[<span class="string">"Annualized Std Dev"</span>,])</div><div class="line">max.return &lt;- max(ar.tab[<span class="string">"Annualized Return"</span>,])</div><div class="line">chart.RiskReturnScatter(rets,</div><div class="line">                        main = <span class="string">"SPDR Performance"</span>, colorset = rich10equal,</div><div class="line">                        xlim = c(<span class="number">0</span>, max.risk * <span class="number">1.1</span>), ylim = c(<span class="number">0</span>, max.return))</div></pre></td></tr></table></figure>


                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2018/02/02/[日常] 2018年02月02日/" data-toggle="tooltip" data-placement="top" title="2018年01月28日">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2018/01/31/[SQL] bulk insert/" data-toggle="tooltip" data-placement="top" title="[SQL] bulk insert">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->
            </div>

            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="nav">none</ol>
        
        </div>
      </aside>
    


            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#R" title="R">R</a>
                        
                          <a class="tag" href="/tags/#quant" title="quant">quant</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://feng.li" target="_blank">李丰</a></li>
                    
                        <li><a href="https://blog.youxu.info/" target="_blank">徐宥</a></li>
                    
                        <li><a href="http://blog.sina.com.cn/u/3561429942" target="_blank">李安琪</a></li>
                    
                        <li><a href="https://yihui.name/" target="_blank">谢益辉</a></li>
                    
                        <li><a href="http://www.cnfeat.com/" target="_blank">陈素封</a></li>
                    
                        <li><a href="http://www.kuangnanfang.com/" target="_blank">方匡南</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
<!-- 控制文章是否需要捐赠 -->
    
    	<! -- 添加捐赠图标-->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
		   无以生计，卖文苟延
        </span>
        <br>
      </div>
	<div id="donate_guide" class="donate_bar center hidden" >
		<!-- ֧支付宝打赏-->
		<img src="/css/img/zhifubao.jpg" alt="֧支付宝打赏">
		<!-- 微信打赏 -->
		<img src="/css/img/weixin.jpg" alt="微信打赏">
    </div>
	<script type="text/javascript">
		document.getElementById('btn_donate').onclick = function(){
			$('#donate_board').addClass('hidden');
			$('#donate_guide').removeClass('hidden');
		}
	</script>
</div>
<! -- 添加捐赠图标-->

    
<!-- 控制文章是否加载公式 -->

<!-- 控制文章是否需要密码 2017-08-07-->

</article>




<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "liangzhenghua";
    var disqus_identifier = "https://liangzhenghua.github.io/2018/02/02/[Manual] R语言quantstrat包使用手册/";
    var disqus_url = "https://liangzhenghua.github.io/2018/02/02/[Manual] R语言quantstrat包使用手册/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<!-- 修改文章章节标题前面的符号 icon: 'ℬ'  -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>





    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/liangzhenghua">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/liang-zheng-hua">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/u/2161168802">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="https://www.facebook.com/liangzhenghua">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://github.com/liangzhenghua">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank"  href="https://www.linkedin.com/in/政华-梁-b50b79125/">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Leung ZhengHua 2018 
                    <br>
                    I love <a href="http://cos.name/">statistics</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    study at <a href="http://sam.cufe.edu.cn/">CUFE</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true" >
                    </iframe>
					<span id="busuanzi_container_site_uv">
                       你是第<span id="busuanzi_value_site_uv"></span>个不打招呼就跑进来的
                    </span>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://liangzhenghua.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->

<script>
    // dynamic User by Hux
    var _baId = 'e30fab4462a11afb967103745531c6b4';

    // Originial
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?" + _baId;
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- website count lzh -->
<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
</script>




	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://liangzhenghua.github.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
